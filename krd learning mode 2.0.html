<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA & Mobile Meta Tags -->
    <title>Kit Roda Darab PdP Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RodaDarab">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');

        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
            --accent: #f59e0b;
            --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #1f2937;
            font-size: 1.1rem;
            -webkit-tap-highlight-color: transparent;
        }

        .animate-fade-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(31, 38, 135, 0.1);
        }

        .mnl-active {
            background: #4f46e5 !important;
            color: white !important;
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .step-box {
            border-left: 6px solid #4f46e5;
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.3s ease-out;
        }

        .wheel-label, .ans-label {
            pointer-events: none;
            font-weight: 900;
        }

        .sector-highlight {
            stroke: #4f46e5;
            stroke-width: 5;
            fill: #eef2ff !important;
        }

        /* Print Styles */
        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; color: black; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }

        #reader {
            width: 100% !important;
            border: none !important;
            border-radius: 1.5rem;
            overflow: hidden;
        }

        /* LCD Mode Styles */
        .lcd-timer {
            font-size: 10rem;
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .lcd-timer { font-size: 5rem; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto no-print">
        <!-- Header -->
        <div class="text-center mb-10 animate-fade-up">
            <h1 class="text-4xl md:text-6xl font-black text-indigo-700 mb-2 leading-tight">Kit Roda Darab</h1>
            <p class="text-lg md:text-xl text-indigo-500 font-bold" id="headerSubtitle">Sistem Rekod Prestasi & PdP Pintar</p>
            
            <div class="flex flex-wrap justify-center gap-2 md:gap-4 mt-8">
                <button onclick="toggleLang()" id="langBtn" class="bg-white px-4 py-2 md:px-6 md:py-3 rounded-full shadow-md border-2 border-indigo-100 hover:bg-indigo-50 transition font-black text-indigo-600 text-sm md:text-base">
                    üá≤üáæ Bahasa Melayu
                </button>
                <button onclick="openStudentManager()" class="bg-emerald-600 text-white px-4 py-2 md:px-8 md:py-3 rounded-full shadow-xl hover:bg-emerald-700 transition font-black flex items-center gap-2 text-sm md:text-base">
                    üë• Rekod
                </button>
                <button onclick="toggleScanner()" class="bg-amber-500 text-white px-4 py-2 md:px-8 md:py-3 rounded-full shadow-xl hover:bg-amber-600 transition font-black flex items-center gap-2 text-sm md:text-base">
                    üì∑ Imbas
                </button>
                <button onclick="openLCDMode()" class="bg-indigo-900 text-white px-4 py-2 md:px-8 md:py-3 rounded-full shadow-xl hover:bg-black transition font-black flex items-center gap-2 text-sm md:text-base">
                    üñ•Ô∏è LCD
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
            
            <!-- Panel Kawalan -->
            <div class="lg:col-span-4 space-y-6 animate-fade-up">
                <!-- Info Murid Aktif -->
                <div class="glass-card p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] border-b-8 border-indigo-500">
                    <h3 class="text-[10px] md:text-sm font-black text-gray-400 uppercase mb-4 tracking-widest">Sesi Aktif</h3>
                    <div id="activeStudentDisplay" class="p-4 bg-indigo-50 rounded-2xl border-2 border-indigo-100 min-h-[100px] flex flex-col justify-center text-center">
                        <p class="text-gray-400 font-bold italic text-sm" id="noStudentText">Imbas lembaran murid untuk mula</p>
                        <div id="studentDetail" class="hidden">
                            <p class="text-2xl font-black text-indigo-700 leading-tight" id="dispName"></p>
                            <p class="text-lg font-bold text-indigo-400" id="dispClass"></p>
                        </div>
                    </div>
                </div>

                <!-- Mod & Sifir -->
                <div class="glass-card p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] space-y-6">
                    <div>
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">Mod</h3>
                        <div class="grid grid-cols-2 gap-2 md:gap-4">
                            <button onclick="setMode('learn')" id="btnLearn" class="py-3 md:py-4 rounded-xl md:rounded-2xl font-black text-base md:text-lg transition-all border-2 border-indigo-600 bg-indigo-600 text-white shadow-lg">Belajar</button>
                            <button onclick="setMode('practice')" id="btnPractice" class="py-3 md:py-4 rounded-xl md:rounded-2xl font-black text-base md:text-lg transition-all border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50">Latihan</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">Sifir</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <script>
                                for(let i=1; i<=9; i++) {
                                    document.write(`<button onclick="selectSifir(${i})" id="sifir-${i}" class="sifir-btn h-12 md:h-14 rounded-xl md:rounded-2xl font-black text-lg md:text-xl border-2 border-gray-100 hover:border-indigo-300 transition-all text-gray-600 bg-white shadow-sm">${i}</button>`);
                                }
                            </script>
                        </div>
                    </div>
                </div>

                <div id="scoreCard" class="glass-card p-6 md:p-8 rounded-[2rem] hidden bg-white border-emerald-500 border-b-8">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-black text-emerald-700 text-xl">Skor</span>
                        <span class="text-4xl font-black text-emerald-600" id="currentScore">0/0</span>
                    </div>
                    <div class="flex justify-between items-center bg-emerald-50 p-4 rounded-2xl border-2 border-emerald-100">
                        <span class="text-xs font-black text-emerald-600 uppercase">PEMASA</span>
                        <span class="text-3xl font-mono font-black text-emerald-700" id="timerDisplay">00:00</span>
                    </div>
                </div>
            </div>

            <!-- Panel Interaksi -->
            <div class="lg:col-span-8 space-y-6 md:space-y-8 animate-fade-up">
                
                <!-- Magic Number Line -->
                <div class="glass-card p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] overflow-x-auto border-t-8 border-indigo-100">
                    <h3 class="text-center font-black text-indigo-400 mb-6 text-[10px] md:text-sm uppercase tracking-widest">Garis Nombor Ajaib</h3>
                    <div class="flex justify-between items-center mnl-strip relative min-w-[500px] md:min-w-0">
                        <script>
                            const mnlActionsList = ["+1", "+2", "+3", "+4", "¬±5", "-4", "-3", "-2", "-1"];
                            for(let i=1; i<=9; i++) {
                                document.write(`
                                    <div id="mnl-${i}" class="z-10 w-10 h-10 md:w-12 md:h-12 rounded-full bg-white border-2 border-gray-200 flex flex-col items-center justify-center transition-all duration-300">
                                        <span class="text-sm font-black">${i}</span>
                                        <span class="text-[9px] font-black text-indigo-500">${mnlActionsList[i-1]}</span>
                                    </div>
                                `);
                            }
                        </script>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 items-start">
                    <div id="wheelWrapper" class="relative w-72 h-72 md:w-96 md:h-96 bg-white rounded-full shadow-inner border-4 border-dashed border-gray-100 flex items-center justify-center mx-auto">
                        <span class="text-gray-300 font-black text-center p-6 text-lg">Sila pilih sifir</span>
                    </div>

                    <div id="guidePanel" class="glass-card p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] min-h-[400px] md:min-h-[500px] border-l-[10px] border-indigo-500 flex flex-col shadow-2xl">
                        <div id="guideContent" class="flex-grow overflow-y-auto">
                            <!-- Dinamik -->
                        </div>
                        <div id="guideActions" class="mt-6 flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- LCD / Class Challenge Modal -->
    <div id="lcdModal" class="fixed inset-0 bg-indigo-950 hidden z-[100] flex flex-col items-center justify-center p-4 md:p-8">
        <div class="w-full max-w-6xl text-center space-y-6 md:space-y-12">
            <h2 class="text-indigo-200 text-xl md:text-3xl font-black uppercase tracking-[0.2em] md:tracking-[0.5em]">Cabaran Sifir 2-9</h2>
            
            <div class="flex flex-col items-center">
                <div id="lcdTimerDisplay" class="lcd-timer text-white font-mono">10:00</div>
                <div class="flex gap-4 mt-8 no-print">
                    <button id="lcdStartBtn" onclick="startLcdCountdown()" class="px-6 py-4 md:px-12 md:py-6 bg-emerald-500 text-white rounded-2xl md:rounded-3xl font-black text-xl md:text-3xl shadow-2xl hover:bg-emerald-600 transition-all">MULA</button>
                    <button onclick="resetLcdCountdown()" class="px-6 py-4 md:px-12 md:py-6 bg-indigo-800 text-indigo-200 rounded-2xl md:rounded-3xl font-black text-xl md:text-3xl shadow-2xl hover:bg-indigo-700 transition-all">RESET</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
                <div class="p-4 md:p-8 bg-indigo-900/50 rounded-2xl md:rounded-[2rem] border-2 border-indigo-800">
                    <p class="text-indigo-400 font-bold uppercase text-xs mb-2">Masa</p>
                    <select id="lcdTimeSelect" class="bg-transparent text-white text-2xl md:text-4xl font-black outline-none cursor-pointer">
                        <option value="300" class="text-black">5 MIN</option>
                        <option value="420" class="text-black">7 MIN</option>
                        <option value="600" class="text-black" selected>10 MIN</option>
                        <option value="900" class="text-black">15 MIN</option>
                    </select>
                </div>
                <div class="p-4 md:p-8 bg-indigo-900/50 rounded-2xl md:rounded-[2rem] border-2 border-indigo-800 col-span-1 md:col-span-3">
                    <p class="text-indigo-400 font-bold uppercase text-xs mb-2">Murid Terkini</p>
                    <p id="lcdStudentName" class="text-white text-xl md:text-3xl font-black tracking-tight">SEMUA MURID</p>
                </div>
            </div>

            <button onclick="closeLCDMode()" class="absolute top-6 right-6 md:top-10 md:right-10 text-indigo-400 hover:text-white text-3xl md:text-5xl font-black no-print">√ó</button>
        </div>
    </div>

    <!-- Student & Record Manager Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center p-4">
        <div class="glass-card w-full max-w-4xl p-6 md:p-8 rounded-[2rem] md:rounded-[3rem] animate-fade-up max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl md:text-4xl font-black text-indigo-700">Pangkalan Data & Rekod</h2>
                <button onclick="closeStudentManager()" class="text-gray-400 hover:text-red-500 text-3xl md:text-5xl font-black">√ó</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="p-6 bg-gray-50 rounded-[2rem] border-2 border-gray-100">
                        <h3 class="font-black text-indigo-600 mb-4 uppercase text-xs tracking-widest">Daftar Murid</h3>
                        <div class="space-y-4">
                            <input type="text" id="addName" placeholder="Nama Penuh" class="w-full px-5 py-3 rounded-2xl border-2 border-gray-100 outline-none font-bold">
                            <input type="text" id="addClass" placeholder="Kelas" class="w-full px-5 py-3 rounded-2xl border-2 border-gray-100 outline-none font-bold">
                            <button onclick="addStudent()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Simpan</button>
                        </div>
                    </div>
                    <div id="studentList" class="space-y-2 overflow-y-auto max-h-[250px] pr-2"></div>
                </div>
                <div class="p-6 bg-white border-4 border-indigo-50 rounded-[2rem]">
                    <h3 class="font-black text-emerald-600 mb-4 uppercase text-xs tracking-widest">Rekod Prestasi Kertas</h3>
                    <div id="gradebookList" class="space-y-3 overflow-y-auto max-h-[350px]"></div>
                </div>
            </div>
            
            <button onclick="generateTestForAll()" class="w-full mt-8 py-4 md:py-5 bg-emerald-600 text-white rounded-2xl md:rounded-3xl font-black text-lg md:text-xl shadow-xl">Cetak Lembaran Kerja (QR)</button>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center p-6">
        <div class="glass-card w-full max-w-lg p-6 rounded-3xl animate-fade-up text-center">
            <h2 class="text-2xl font-black text-indigo-700 mb-4 tracking-tighter">Detect Lembaran Murid</h2>
            <div id="reader"></div>
            <button onclick="toggleScanner()" class="mt-6 py-4 px-10 bg-gray-100 text-gray-600 rounded-2xl font-black">Tutup</button>
        </div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 md:p-8 rounded-[2rem] md:rounded-[3rem] animate-fade-up shadow-2xl border-indigo-500 border-t-8">
            <h2 class="text-2xl font-black text-indigo-700 mb-2">Rekod Hasil</h2>
            <p id="entryStudentInfo" class="text-gray-500 font-bold mb-6 text-sm"></p>
            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-2 text-center tracking-widest">Sifir</label>
                    <div class="grid grid-cols-5 gap-2" id="entrySifirGrid"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Betul (/10)</label>
                        <input type="number" id="entryScore" min="0" max="10" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-100 font-black text-2xl text-center outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Masa (s)</label>
                        <input type="number" id="entryTime" placeholder="45" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-100 font-black text-2xl text-center outline-none">
                    </div>
                </div>
                <button onclick="saveEntry()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg shadow-lg">Simpan Rekod</button>
                <button onclick="closeEntryModal()" class="w-full py-2 text-gray-400 font-bold text-sm">Batal</button>
            </div>
        </div>
    </div>

    <!-- Print Area -->
    <div id="printArea" class="hidden bg-white"></div>

    <script>
        // PWA Manifest Setup
        const manifest = {
            name: "Kit Roda Darab PdP Pro",
            short_name: "RodaDarab",
            start_url: ".",
            display: "standalone",
            background_color: "#e0e7ff",
            theme_color: "#4f46e5",
            icons: [{
                src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzRmNDZlNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQ9Ik0yNTYgMTYwdjE5Mm0tOTYtOTZoMTkyIiBzdHJva2U9IiM0ZjQ2ZTUiIHN0cm9rZS13aWR0aD0iNDAiLz48L3N2Zz4=",
                sizes: "512x512",
                type: "image/png"
            }]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestURL;
        document.head.appendChild(manifestLink);

        // --- Init State ---
        let currentSifir = null, currentMode = 'learn', lang = 'ms';
        let score = { correct: 0, total: 0 }, activeMultiplier = null, currentSubStep = 0;
        let timerInterval = null, timeElapsed = 0, html5QrCode = null;
        let students = JSON.parse(localStorage.getItem('krd_students_v2') || '[]');
        let records = JSON.parse(localStorage.getItem('krd_records_v2') || '[]');
        let activeStudent = null, scanTargetSifir = 1;
        let lcdCountdownInterval = null, lcdTimeLeft = 600;

        const krdActions = {
            1: { val: 1, type: 'plus', display: '+1' }, 2: { val: 2, type: 'plus', display: '+2' },
            3: { val: 3, type: 'plus', display: '+3' }, 4: { val: 4, type: 'plus', display: '+4' },
            5: { val: 5, type: 'both', display: '¬±5' }, 6: { val: 4, type: 'minus', display: '-4' },
            7: { val: 3, type: 'minus', display: '-3' }, 8: { val: 2, type: 'minus', display: '-2' },
            9: { val: 1, type: 'minus', display: '-1' }
        };

        // --- Core ---
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnLearn').className = mode === 'learn' ? 'py-4 rounded-xl font-black text-base border-2 border-indigo-600 bg-indigo-600 text-white shadow-lg' : 'py-4 rounded-xl font-black text-base border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50';
            document.getElementById('btnPractice').className = mode === 'practice' ? 'py-4 rounded-xl font-black text-base border-2 border-emerald-600 bg-emerald-600 text-white shadow-lg' : 'py-4 rounded-xl font-black text-base border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50';
            document.getElementById('scoreCard').classList.toggle('hidden', mode === 'learn');
            resetApp();
        }

        function selectSifir(num) {
            currentSifir = num;
            resetTimer();
            document.querySelectorAll('.sifir-btn').forEach(b => b.classList.remove('border-indigo-600', 'bg-indigo-50', 'text-indigo-600'));
            const btn = document.getElementById(`sifir-${num}`);
            if(btn) btn.classList.add('border-indigo-600', 'bg-indigo-50', 'text-indigo-600');
            document.querySelectorAll('[id^="mnl-"]').forEach(m => m.classList.remove('mnl-active'));
            const mnl = document.getElementById(`mnl-${num}`);
            if(mnl) mnl.classList.add('mnl-active');
            renderWheel(num);
            document.getElementById('guideContent').innerHTML = `<div class="text-center mt-6 md:mt-10"><h2 class="text-3xl md:text-5xl font-black text-indigo-700 leading-tight tracking-tight">SIFIR ${num}</h2><p class="text-sm md:text-lg font-bold text-gray-400 mt-4 uppercase tracking-[0.2em]">Klik Roda Untuk Bermula</p></div>`;
            document.getElementById('guideActions').innerHTML = "";
        }

        function renderWheel(num) {
            const wrapper = document.getElementById('wheelWrapper');
            wrapper.innerHTML = '';
            const center = 200, svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", `0 0 400 400`);
            svg.classList.add("w-full", "h-full");

            for (let i = 0; i < 10; i++) {
                const angle = 36, startA = i*angle-90, endA = (i+1)*angle-90;
                const pathData = createArcPath(center, center, 100, 190, startA, endA);
                const g = document.createElementNS(svgNS, "g");
                g.classList.add("cursor-pointer");
                g.onclick = () => handleSegmentClick(i+1);
                const sector = document.createElementNS(svgNS, "path");
                sector.setAttribute("d", pathData); sector.setAttribute("fill", "white"); sector.setAttribute("stroke", "#e5e7eb"); sector.setAttribute("stroke-width", "2");
                sector.id = `sector-${i+1}`; sector.classList.add("transition-all", "hover:fill-indigo-50");
                const rad = ((startA + 18) * Math.PI) / 180;
                const tx = center + Math.cos(rad) * 75, ty = center + Math.sin(rad) * 75;
                const label = document.createElementNS(svgNS, "text");
                label.setAttribute("x", tx); label.setAttribute("y", ty); label.setAttribute("text-anchor", "middle"); label.setAttribute("alignment-baseline", "middle");
                label.classList.add("wheel-label", "text-[20px]", "fill-indigo-900"); label.textContent = i+1;
                const px = center + Math.cos(rad) * 145, py = center + Math.sin(rad) * 145;
                const ans = document.createElementNS(svgNS, "text");
                ans.setAttribute("x", px); ans.setAttribute("y", py+8); ans.setAttribute("text-anchor", "middle");
                ans.classList.add("ans-label", "text-[22px]", "fill-gray-300"); ans.id = `ans-${i+1}`; ans.textContent = "??";
                g.appendChild(sector); g.appendChild(label); g.appendChild(ans); svg.appendChild(g);
            }
            const c = document.createElementNS(svgNS, "circle");
            c.setAttribute("cx", center); c.setAttribute("cy", center); c.setAttribute("r", 45); c.setAttribute("fill", "#4f46e5");
            const ct = document.createElementNS(svgNS, "text");
            ct.setAttribute("x", center); ct.setAttribute("y", center+8); ct.setAttribute("text-anchor", "middle"); ct.classList.add("fill-white", "font-black", "text-[26px]");
            ct.textContent = `${num}√ó`;
            svg.appendChild(c); svg.appendChild(ct); wrapper.appendChild(svg);
        }

        // --- LCD Mode Functions ---
        function openLCDMode() {
            document.getElementById('lcdModal').classList.remove('hidden');
            document.getElementById('lcdStudentName').innerText = activeStudent ? activeStudent.name.toUpperCase() : "SEMUA MURID";
            resetLcdCountdown();
        }

        function closeLCDMode() {
            document.getElementById('lcdModal').classList.add('hidden');
            resetLcdCountdown();
        }

        function startLcdCountdown() {
            if(lcdCountdownInterval) {
                clearInterval(lcdCountdownInterval);
                lcdCountdownInterval = null;
                document.getElementById('lcdStartBtn').innerText = "TERUSKAN";
                return;
            }
            const select = document.getElementById('lcdTimeSelect');
            if(lcdTimeLeft <= 0) lcdTimeLeft = parseInt(select.value);
            document.getElementById('lcdStartBtn').innerText = "BERHENTI";
            lcdCountdownInterval = setInterval(() => {
                lcdTimeLeft--; updateLcdDisplay();
                if(lcdTimeLeft <= 0) {
                    clearInterval(lcdCountdownInterval); lcdCountdownInterval = null;
                    alert("MASA TAMAT!"); resetLcdCountdown();
                }
            }, 1000);
        }

        function resetLcdCountdown() {
            clearInterval(lcdCountdownInterval); lcdCountdownInterval = null;
            const select = document.getElementById('lcdTimeSelect');
            lcdTimeLeft = parseInt(select.value); updateLcdDisplay();
            document.getElementById('lcdStartBtn').innerText = "MULA";
        }

        function updateLcdDisplay() {
            const m = Math.floor(lcdTimeLeft / 60).toString().padStart(2, '0');
            const s = (lcdTimeLeft % 60).toString().padStart(2, '0');
            document.getElementById('lcdTimerDisplay').innerText = `${m}:${s}`;
        }

        // --- Data ---
        function openStudentManager() { document.getElementById('studentModal').classList.remove('hidden'); renderStudentList(); renderGradebook(); }
        function closeStudentManager() { document.getElementById('studentModal').classList.add('hidden'); }
        function renderStudentList() {
            const list = document.getElementById('studentList');
            list.innerHTML = students.length ? '' : '<p class="text-center text-gray-300 py-6 font-bold uppercase">Tiada Data</p>';
            students.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-white rounded-xl border-2 border-gray-100";
                div.innerHTML = `<div class="text-left leading-tight"><p class="font-black text-indigo-900 text-sm">${s.name}</p><p class="text-[10px] font-bold text-gray-400">${s.kls}</p></div><button onclick="removeStudent(${idx})" class="text-red-300 font-black text-xl">√ó</button>`;
                list.appendChild(div);
            });
        }
        function addStudent() {
            const n = document.getElementById('addName').value, k = document.getElementById('addClass').value;
            if(!n || !k) return;
            students.push({ name: n, kls: k });
            localStorage.setItem('krd_students_v2', JSON.stringify(students));
            document.getElementById('addName').value = ''; document.getElementById('addClass').value = '';
            renderStudentList();
        }
        function removeStudent(idx) { students.splice(idx, 1); localStorage.setItem('krd_students_v2', JSON.stringify(students)); renderStudentList(); }
        function renderGradebook() {
            const list = document.getElementById('gradebookList');
            list.innerHTML = records.length ? '' : '<p class="text-center text-gray-300 py-6 font-bold uppercase">Tiada Rekod</p>';
            [...records].reverse().forEach((r) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-indigo-50 border border-indigo-100 rounded-xl flex justify-between items-center";
                div.innerHTML = `<div class="text-left leading-tight"><p class="font-black text-indigo-900 text-xs">${r.name}</p><p class="text-[9px] font-bold text-indigo-400">Sifir ${r.sifir} | ${r.score}/10 | ${r.time}s</p></div><span class="text-[9px] font-black text-indigo-300">${r.date}</span>`;
                list.appendChild(div);
            });
        }
        function clearAllData() { if(confirm("Padam semua?")) { students=[]; records=[]; localStorage.clear(); renderStudentList(); renderGradebook(); }}

        // --- Detection ---
        function toggleScanner() {
            const modal = document.getElementById('scannerModal');
            if (!modal.classList.contains('hidden')) {
                if (html5QrCode) html5QrCode.stop().then(() => html5QrCode = null);
                modal.classList.add('hidden');
            } else {
                modal.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                    if(text.startsWith("LOGIN:")) {
                        const parts = text.replace("LOGIN:", "").split("|");
                        activeStudent = { name: parts[0], kls: parts[1] };
                        toggleScanner(); openEntryModal();
                    }
                }).catch(() => { alert("Kamera gagal."); toggleScanner(); });
            }
        }
        function openEntryModal() {
            if(!activeStudent) return;
            document.getElementById('entryModal').classList.remove('hidden');
            document.getElementById('entryStudentInfo').innerText = `${activeStudent.name} (${activeStudent.kls})`;
            const g = document.getElementById('entrySifirGrid'); g.innerHTML = "";
            for(let i=1; i<=9; i++) {
                const b = document.createElement('button');
                b.className = `p-2 rounded-lg font-black border-2 ${scanTargetSifir==i?'bg-indigo-600 text-white border-indigo-600':'bg-white text-gray-600 border-gray-100'}`;
                b.innerText = i; b.onclick = () => { scanTargetSifir = i; openEntryModal(); };
                g.appendChild(b);
            }
        }
        function closeEntryModal() { document.getElementById('entryModal').classList.add('hidden'); }
        function saveEntry() {
            const s = document.getElementById('entryScore').value, t = document.getElementById('entryTime').value;
            if(!s || !t) return;
            records.push({ name: activeStudent.name, kls: activeStudent.kls, sifir: scanTargetSifir, score: s, time: t, date: new Date().toLocaleDateString('ms-MY', {day:'2-digit', month:'short'}) });
            localStorage.setItem('krd_records_v2', JSON.stringify(records));
            document.getElementById('studentDetail').classList.remove('hidden');
            document.getElementById('noStudentText').classList.add('hidden');
            document.getElementById('dispName').innerText = activeStudent.name;
            document.getElementById('dispClass').innerText = activeStudent.kls;
            closeEntryModal();
        }

        // --- Helpers ---
        function createArcPath(x, y, innerR, outerR, startAngle, endAngle) {
            const sR = startAngle * Math.PI / 180, eR = endAngle * Math.PI / 180;
            return `M ${x+Math.cos(sR)*outerR} ${y+Math.sin(sR)*outerR} A ${outerR} ${outerR} 0 0 1 ${x+Math.cos(eR)*outerR} ${y+Math.sin(eR)*outerR} L ${x+Math.cos(eR)*innerR} ${y+Math.sin(eR)*innerR} A ${innerR} ${innerR} 0 0 0 ${x+Math.cos(sR)*innerR} ${y+Math.sin(sR)*innerR} Z`;
        }
        function startTimer() { if (timerInterval) return; let sT = Date.now(); timerInterval = setInterval(() => { timeElapsed = Math.floor((Date.now()-sT)/1000); const m = Math.floor(timeElapsed/60).toString().padStart(2,'0'), s = (timeElapsed%60).toString().padStart(2,'0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; }, 1000); }
        function resetTimer() { clearInterval(timerInterval); timerInterval = null; timeElapsed = 0; if(document.getElementById('timerDisplay')) document.getElementById('timerDisplay').innerText = "00:00"; }
        function resetApp() { currentSifir = null; score = { correct: 0, total: 0 }; document.getElementById('currentScore').innerText = "0/0"; resetTimer(); document.getElementById('wheelWrapper').innerHTML = `<span class="text-gray-300 font-black text-center p-6 text-lg">Sila pilih sifir</span>`; document.getElementById('guideContent').innerHTML = `<h2 class="text-2xl font-black text-indigo-700 text-center mt-6">Panduan Roda</h2><p class="text-center font-bold text-gray-400 mt-2 uppercase text-sm tracking-widest">Eksplorasi langkah sifir secara visual.</p>`; document.getElementById('guideActions').innerHTML = ""; }
        function toggleLang() { lang = lang === 'ms' ? 'en' : 'ms'; resetApp(); }
        function handleSegmentClick(m) {
            if(currentMode === 'practice' && !timerInterval && score.total === 0) startTimer();
            activeMultiplier = m; document.querySelectorAll('path').forEach(p => p.classList.remove('sector-highlight'));
            const s = document.getElementById(`sector-${m}`); if(s) s.classList.add('sector-highlight');
            if(currentMode === 'learn') { currentSubStep = 1; updateLearnUI(); } else { startPracticeUI(); }
        }
        function updateLearnUI() {
            const m = activeMultiplier, res = currentSifir * m, prevSa = (currentSifir * (m-1)) % 10, currSa = res % 10, action = krdActions[currentSifir];
            let content = `<h2 class="text-3xl font-black text-indigo-700 mb-6 text-center">${currentSifir} √ó ${m}</h2>`;
            if(currentSubStep >= 1) content += `<div class="step-box bg-amber-50 border-amber-500 shadow-sm"><p class="text-[10px] font-black text-amber-600 uppercase mb-2">Langkah 1: Cari Sa</p><div class="flex items-center gap-4"><span class="text-xl font-black">${prevSa}</span><span class="text-xl font-black text-indigo-600">${action.display}</span><span class="text-3xl font-black text-amber-700">‚ûî ${currSa}</span></div></div>`;
            if(currentSubStep >= 2) content += `<div class="step-box bg-indigo-50 shadow-sm"><p class="text-[10px] font-black text-indigo-600 uppercase mb-2">Langkah 2: Cari Puluh</p><p class="text-lg font-black text-indigo-800">${(prevSa > currSa && m > 1) ? "Sa Menurun: Puluh +1" : "Sa Naik/Sama: Puluh Kekal"}</p></div>`;
            if(currentSubStep === 3) {
                const ans = document.getElementById(`ans-${m}`); ans.textContent = res < 10 ? `0${res}` : res; ans.classList.replace('fill-gray-300', 'fill-indigo-600');
                content += `<div class="mt-4 p-6 bg-indigo-600 text-white rounded-2xl text-center shadow-xl animate-fade-up"><p class="text-5xl font-black">${res}</p></div>`;
                document.getElementById('guideActions').innerHTML = `<button onclick="selectSifir(${currentSifir})" class="w-full py-4 bg-gray-100 rounded-xl font-black text-lg text-gray-500">Seterusnya!</button>`;
            } else { document.getElementById('guideActions').innerHTML = `<button onclick="currentSubStep++; updateLearnUI();" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-black text-lg shadow-xl">${currentSubStep === 1 ? "Langkah Seterusnya" : "Lihat Jawapan"}</button>`; }
            document.getElementById('guideContent').innerHTML = content;
        }
        function startPracticeUI() {
            const currSa = (currentSifir * activeMultiplier) % 10;
            document.getElementById('guideContent').innerHTML = `<h2 class="text-xl font-black text-emerald-700 mb-6 text-center tracking-widest uppercase">Berapakah nilai SA?</h2><div class="grid grid-cols-5 gap-2">${[0,1,2,3,4,5,6,7,8,9].map(i => `<button onclick="checkSa(${i}, ${currSa})" class="h-12 bg-white border-2 border-emerald-100 rounded-xl font-black text-xl shadow-sm">${i}</button>`).join('')}</div>`;
            document.getElementById('guideActions').innerHTML = "";
        }
        function checkSa(val, correct) {
            if(val === correct) {
                const prevSa = (currentSifir * (activeMultiplier-1)) % 10, correctRule = (prevSa > correct && activeMultiplier > 1) ? 'A' : 'B';
                score.correct++; updatePracticeRuleUI(correctRule);
            } else alert("Kurang tepat!");
            score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
        }
        function updatePracticeRuleUI(correct) {
            document.getElementById('guideContent').innerHTML = `<h2 class="text-xl font-black text-emerald-700 mb-6 text-center tracking-widest uppercase">Peraturan PULUH?</h2><div class="grid grid-cols-1 gap-3"><button onclick="checkRule('A', '${correct}')" class="py-4 bg-white border-2 border-emerald-100 rounded-2xl font-black text-base text-emerald-700 shadow-sm">A (Menurun: Puluh +1)</button><button onclick="checkRule('B', '${correct}')" class="py-4 bg-white border-2 border-emerald-100 rounded-2xl font-black text-base text-emerald-700 shadow-sm">B (Naik/Sama: Puluh Kekal)</button></div>`;
        }
        function checkRule(val, correct) {
            if(val === correct || activeMultiplier === 1) {
                const res = currentSifir * activeMultiplier;
                const ans = document.getElementById(`ans-${activeMultiplier}`); ans.textContent = res < 10 ? `0${res}` : res; ans.classList.replace('fill-gray-300', 'fill-emerald-600');
                document.getElementById('guideContent').innerHTML = `<div class="text-center py-6 animate-fade-up"><p class="text-6xl font-black text-emerald-600 leading-none">${res}</p><p class="mt-4 text-xl font-black text-emerald-500 uppercase tracking-widest">TEPAT SEKALI!</p></div>`;
                document.getElementById('guideActions').innerHTML = `<button onclick="nextPractice()" class="w-full py-4 bg-emerald-500 text-white rounded-2xl font-black text-xl shadow-xl">Teruskan!</button>`;
                score.correct++;
            } else alert("Peraturan tidak tepat!");
            score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
        }
        function nextPractice() {
            let answered = 0;
            for(let i=1; i<=10; i++) { if(document.getElementById(`ans-${i}`).textContent !== "??") answered++; }
            if (answered === 10) finishPractice();
            else { document.getElementById('guideContent').innerHTML = `<div class="flex flex-col items-center justify-center min-h-[300px]"><p class="text-2xl font-black text-gray-300 text-center uppercase tracking-[0.2em] leading-relaxed">Pilih segmen seterusnya...</p></div>`; document.getElementById('guideActions').innerHTML = ""; }
        }
        function finishPractice() {
            resetTimer(); const n = activeStudent ? activeStudent.name : "Murid", k = activeStudent ? activeStudent.kls : "Tiada", data = `STUDENT:${n}|CLASS:${k}|SCORE:${score.correct}/${score.total}`;
            const qr = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data)}`;
            document.getElementById('guideContent').innerHTML = `<div class="text-center animate-fade-up"><h2 class="text-2xl font-black text-indigo-700 mb-4 uppercase">Selesai!</h2><div class="flex justify-center mb-4"><img src="${qr}" class="w-40 h-40 border-4 border-white shadow-xl rounded-2xl"></div><div class="text-left bg-indigo-50 p-4 rounded-2xl border-2 border-indigo-100"><p class="text-lg font-black text-indigo-800 leading-tight">${n}</p><p class="font-bold text-indigo-500 text-sm">${k}</p></div></div>`;
            document.getElementById('guideActions').innerHTML = `<button onclick="resetApp()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg">Mula Baru</button>`;
        }
        function generateTestForAll() {
            if(!students.length) return alert("Sila daftar murid.");
            const p = document.getElementById('printArea'); p.innerHTML = "";
            students.forEach((s) => {
                const pg = document.createElement('div'); pg.className = "p-10 page-break";
                const qr = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent("LOGIN:"+s.name+"|"+s.kls)}`;
                let h = `<div class="flex justify-between items-start border-b-8 border-black pb-6 mb-8"><div><h1 class="text-5xl font-black tracking-tight">KIT RODA DARAB</h1><p class="text-3xl font-bold mt-4 tracking-tighter uppercase">NAMA: ${s.name}</p><p class="text-2xl font-bold uppercase">KELAS: ${s.kls}</p></div><div class="text-center"><img src="${qr}" class="w-32 h-32 border-4 border-black p-1"><p class="text-[10px] font-black mt-2">SCAN REKOD</p></div></div><div class="grid grid-cols-3 gap-8">`;
                for(let sf=2; sf<=9; sf++) {
                    h += `<div class="border-4 border-black p-4 rounded-[3rem] flex flex-col items-center"><svg viewBox="0 0 320 320" class="w-full h-auto">${Array.from({length:10}, (_, i) => { const a = i*36-90, r = ((a + 18) * Math.PI) / 180; return `<path d="${createArcPath(160,160,80,140,a,a+36)}" fill="none" stroke="black" stroke-width="3" /><text x="${160+Math.cos(r)*65}" y="${160+Math.sin(r)*65}" text-anchor="middle" font-size="20" font-weight="900" alignment-baseline="middle">${i+1}</text><text x="${160+Math.cos(r)*110}" y="${160+Math.sin(r)*115}" text-anchor="middle" font-size="14" fill="#ccc">____</text>`; }).join('')}<circle cx="160" cy="160" r="30" fill="none" stroke="black" stroke-width="3" /><text x="160" y="168" text-anchor="middle" font-size="22" font-weight="900">${sf}√ó</text></svg><p class="mt-4 font-black text-xl">SIFIR ${sf}</p></div>`;
                }
                pg.innerHTML = h + `</div><div class="mt-12 flex justify-end gap-10 font-black text-xl italic uppercase"><span>Markah: _____ / 80</span><span>Masa: _________</span></div>`; p.appendChild(pg);
            }); window.print();
        }

        resetApp();
    </script>
</body>
</html>